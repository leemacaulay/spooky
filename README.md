# spooky

spooky is a hauntingly convoluted way to:

- host a [Ghost](https://ghost.org/) blog in a Docker container;
- run its database using MySQL compatible [MariaDB](https://mariadb.org/) in another container;
- and serve it on a reverse proxy using [Traefik](https://traefik.io/) with free HTTPS provided by [Let's Encrypt](https://letsencrypt.org/).

This is _going to_ host my personal portfolio site, lmcly.fyi.

I put this together in a few hours on a bank holiday weekend by judiciously borrowing from other people's tutorials or blog posts.

I can't offer support, because I'm _just a journalist that knows how to google search error messages_, but I'll help where I can.

I'm still working on this and it's at an early stage so please **USE AT YOUR OWN RISK**.

#### Setup

Before you start, you'll need:

- An Ubuntu 16.04 server with Docker and Docker Compose.
  - I recommend firing up a DigitalOcean [Docker Droplet](https://www.digitalocean.com/products/one-click-apps/docker/). $5 a month will get you 1GB memory, 25 GB storage
and 1 TB transfer bandwidth.
  - If you decide to go with DigitalOcean, you can amend and paste cloud-config.yaml by ticking the box [ ] User Data when setting up the droplet.
  - I've also got a [referral link that gets you $10 in credit](https://m.do.co/c/8107dde738c1) (Full transparency: I get $25 credit once someone who uses the link spends $25)
- A domain (example.com) and subdomain (monitor.example.com) pointing towards this server. I use [Cloudflare](cloudflare.com) for DNS.
---
1. Copy or git clone this repo to `/opt` or your home folders.
  - If you choose `/opt` remember to prefix commands with `sudo` where needed.
2. In traefik/traefik.toml, add your email address in the [acme] section.
3. Copy traefik/.env.example -> traefik/.env and edit the following:
  - `TRAEFIK_MONITOR_DOMAIN` is a subdomain you have pointed to the server's IP.
  - `TRAEFIK_MONITOR_AUTH` is a user/password hash generated by `htpasswd -nbm username password` to be used as HTTP basic auth.
4. Create traefik/acme.json with `touch traefik/acme.json` and fix its permission by running `chmod 0600 traefik/acme.json`.
5. In `traefik/`, run `docker-compose up -d` and within a minute or so you should have a reverse proxy up and running.
  - You can check this by heading to the monitor domain you set (i.e. monitor.example.com) and using your username and password.
6. Copy ghost/.env.example -> ghost/.env and edit the following:
  - `MYSQL_ROOT_PASSWORD` is the root password for your MariaDB instance
  - `MYSQL_PASSWORD` is the user password for your MariaDB instance
  - `GHOST_DOMAIN` is the naked domain you will use to host your Ghost blog (don't prepend this with http:// or https://)
  - `MYSQL_DATABASE` or `MYSQL_USER` can be changed if you wish
7. (optional) If you want to use Amazon S3 for image storage, edit the following:
  - `AWS_ACCESS_KEY_ID` is the access key for an IAM user with permissions for a bucket
  - `AWS_SECRET_ACCESS_KEY` is the secret access key as above
  - `GHOST_STORAGE_ADAPTER_S3_PATH_BUCKET` is the unique bucket name
  - `AWS_DEFAULT_REGION` is the region your bucket is in. **This is nearly always required.**
8. In `ghost/`, run `docker-compose up -d` or if you have set up Amazon S3 image storage, run `docker-compose -f docker-compose.yaml -f docker-compose.s3.yaml up -d`
9. Head to your domain to set up your new blog i.e. example.com/ghost

## Troubleshooting

If your container is running successfully, try using either `docker logs ghost` or `docker logs traefik` to see what is going on.

#### I'm getting a browser warning about my https certificate!

Double check that:

- You've set an email address in the [acme] section of traefik/traefik.toml
- You've set `GHOST_DOMAIN` as a naked domain i.e. example.com NOT https://example.com

#### I can't get Amazon S3 image storage working!

WIP

## Upgrading

Want to upgrade to the latest and greatest Ghost?

In ghost/build/Dockerfile, edit the first line to `FROM ghost:X.X` using the version number you need from the [official Docker Hub page for ghost](https://hub.docker.com/_/ghost/)

## Configuration

spooky is mostly configured with .env files. These live in the `ghost` and `traefik` folders. You only really need to change `MYSQL_ROOT_PASSWORD`, `MYSQL_PASSWORD`, `GHOST_DOMAIN`. Even, `TRAEFIK_MONITOR_DOMAIN` is optional, but nice to have.

These are all written as key-value pairs: `GHOST_DOMAIN=example.com`

Here's what you need to know:

##### ghost/.env

Ghost config        | defaults    | notes
--------------------|-------------|-------------------
MYSQL_ROOT_PASSWORD | changeme    |
MYSQL_DATABASE      | db          |
MYSQL_USER          | spooky_user |
MYSQL_PASSWORD      | changeme    |
GHOST_DOMAIN        | example.com | naked domain (no http or https)

S3 Storage config                    | defaults          | notes
-------------------------------------|-------------------|------
GHOST_STORAGE                        | s3                |
AWS_ACCESS_KEY_ID                    |                   |
AWS_SECRET_ACCESS_KEY                |                   |  
GHOST_STORAGE_ADAPTER_S3_PATH_BUCKET | media.example.com |
AWS_DEFAULT_REGION                   | eu-west-2         |
AWS_SIGNATURE_VERSION                | v4                | Needed for most newer zones

##### traefik/.env

env                    | defaults            | notes
-----------------------|---------------------|-------------------
TRAEFIK_MONITOR_DOMAIN | monitor.example.com | optional
TRAEFIK_MONITOR_AUTH   | traefik:$apr1$sTeeHqHw$MzQLko5A3UUoqEzC/a.FT0 | u: traefik p:password

## Thanks & acknowledgements

A lot of the initial work for this is based on a tutorial post written by [Lorenz Vanthillo on Medium](https://medium.com/@lvthillo/deploy-ghost-publishing-platform-and-mysql-using-docker-compose-601b4b95afe7). That includes the idea to build the ghost container separately and add a wait-for-it script to wait for the MariaDB container to be ready.
